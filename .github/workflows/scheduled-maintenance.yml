name: Scheduled Maintenance

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for outdated npm packages
        if: hashFiles('package.json') != ''
        run: |
          npm outdated || true
      
      - name: Check for outdated pip packages
        if: hashFiles('requirements.txt') != ''
        run: |
          pip list --outdated || true
      
      - name: Check Swift package updates
        if: hashFiles('Package.swift') != ''
        run: |
          swift package update --dry-run || true

  stale-issues:
    name: Close Stale Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/stale@v8
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.'
          stale-pr-message: 'This pull request has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.'
          days-before-stale: 60
          days-before-close: 7
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'keep-open,bug,security'
          exempt-pr-labels: 'keep-open'

  repo-health-check:
    name: Repository Health Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check repository health
        run: |
          echo "## üè• Repository Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for required files
          echo "### Required Files" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "README.md" ]; then
            echo "| README.md | ‚úÖ Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| README.md | ‚ùå Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
            echo "| LICENSE | ‚úÖ Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| LICENSE | ‚ö†Ô∏è Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "CONTRIBUTING.md" ]; then
            echo "| CONTRIBUTING.md | ‚úÖ Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CONTRIBUTING.md | ‚ÑπÔ∏è Not found |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f ".gitignore" ]; then
            echo "| .gitignore | ‚úÖ Present |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| .gitignore | ‚ö†Ô∏è Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Recent activity
          echo "### Recent Activity" >> $GITHUB_STEP_SUMMARY
          COMMITS_LAST_WEEK=$(git log --since="1 week ago" --oneline | wc -l)
          COMMITS_LAST_MONTH=$(git log --since="1 month ago" --oneline | wc -l)
          echo "- Commits in last week: $COMMITS_LAST_WEEK" >> $GITHUB_STEP_SUMMARY
          echo "- Commits in last month: $COMMITS_LAST_MONTH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Repository size
          echo "### Repository Statistics" >> $GITHUB_STEP_SUMMARY
          TOTAL_COMMITS=$(git rev-list --all --count)
          TOTAL_FILES=$(find . -type f ! -path '*/\.*' | wc -l)
          echo "- Total commits: $TOTAL_COMMITS" >> $GITHUB_STEP_SUMMARY
          echo "- Total files: $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
          
          # Contributors
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Contributors" >> $GITHUB_STEP_SUMMARY
          git shortlog -sn | head -5 >> $GITHUB_STEP_SUMMARY

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run npm audit
        if: hashFiles('package.json') != ''
        run: |
          npm audit || true
      
      - name: Check for secrets
        run: |
          echo "Scanning for potential secrets..."
          # Basic check for common secret patterns
          if grep -r -E "(password|api_key|secret|token).*=.*['\"][^'\"]{20,}['\"]" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null; then
            echo "‚ö†Ô∏è Potential secrets found! Please review."
          else
            echo "‚úÖ No obvious secrets detected"
          fi
